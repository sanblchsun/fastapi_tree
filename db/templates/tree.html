<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Tree</title>

    <style>
      ul {
        list-style: none;
        padding-left: 20px;
        margin: 0;
      }

      .node {
        display: flex;
        align-items: center;
        user-select: none;
      }

      .arrow {
        cursor: pointer;
        width: 1em;
        margin-right: 6px;
        transition: transform 0.2s ease;
      }

      .arrow.expanded {
        transform: rotate(90deg);
      }

      .label {
        cursor: default;
      }

      .collapsible {
        overflow: hidden;
        max-height: 0;
        transition: max-height 0.25s ease;
      }

      .collapsible.expanded {
        max-height: 2000px;
      }
    </style>
  </head>
  <body>
    <h2>Company Tree</h2>

    <button id="toggle-all-btn" onclick="toggleAll()">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë</button>

    {% macro render_node(node) %}
    <li>
      {% if node.children %}
      <div class="node">
        <span class="arrow" onclick="toggleNode('{{ node.id }}', this)">‚ñ∂</span>

        <span class="label">{{ node.name }}</span>
      </div>

      <ul class="collapsible" data-id="{{ node.id }}">
        {% for child in node.children %} {{ render_node(child) }} {% endfor %}
      </ul>
      {% else %}
      <div class="node">
        <span style="width: 1em"></span>
        <span class="label">
          {% if node.type == "agent" %} üë§ {{ node.name }} {% else %} {{
          node.name }} {% endif %}
        </span>
      </div>
      {% endif %}
    </li>
    {% endmacro %}

    <ul id="tree-root">
      {% for company in companies %} {{ render_node(company) }} {% endfor %}
    </ul>

    <script>
      const STORAGE_KEY = "tree-state";

      /* ---------- state ---------- */

      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : {};
      }

      function saveState(state) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      /* ---------- toggle single node ---------- */

      function toggleNode(id, arrowEl) {
        const ul = document.querySelector(`ul[data-id="${id}"]`);
        if (!ul) return;

        const expanded = ul.classList.toggle("expanded");
        arrowEl.classList.toggle("expanded", expanded);

        const state = loadState();
        state[id] = expanded;
        saveState(state);
      }

      /* ---------- restore on load ---------- */

      window.addEventListener("DOMContentLoaded", () => {
        const state = loadState();

        document.querySelectorAll(".collapsible").forEach((ul) => {
          const id = ul.dataset.id;
          if (state[id]) {
            ul.classList.add("expanded");
            const arrow = ul.previousElementSibling.querySelector(".arrow");
            if (arrow) arrow.classList.add("expanded");
          }
        });
      });

      /* ---------- toggle all ---------- */

      let allExpanded = false;

      function toggleAll() {
        const state = loadState();

        document.querySelectorAll(".collapsible").forEach((ul) => {
          const arrow = ul.previousElementSibling.querySelector(".arrow");

          if (allExpanded) {
            ul.classList.remove("expanded");
            arrow?.classList.remove("expanded");
            state[ul.dataset.id] = false;
          } else {
            ul.classList.add("expanded");
            arrow?.classList.add("expanded");
            state[ul.dataset.id] = true;
          }
        });

        saveState(state);
        allExpanded = !allExpanded;
        document.getElementById("toggle-all-btn").textContent = allExpanded
          ? "–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë"
          : "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë";
      }
    </script>
  </body>
</html>
