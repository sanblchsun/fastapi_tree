<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Company Tree</title>
    <style>
        ul { list-style: none; padding-left: 20px; margin: 0; }
        .node { cursor: pointer; font-weight: bold; user-select: none; display: flex; align-items: center; }
        .arrow { display: inline-block; width: 1em; transition: transform 0.3s ease; margin-right: 5px; }
        .expanded-arrow { transform: rotate(90deg); }
        .collapsible { overflow: hidden; max-height: 0; transition: max-height 0.3s ease; }
        .expanded { max-height: 2000px; }
    </style>
</head>
<body>

<h2>Company Tree</h2>

<button id="toggle-all-btn" onclick="toggleAll()">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë</button>

{% macro render_node(node) %}
<li>
    {% if node.children %}
        <span class="node" onclick="toggle(this)">
            <span class="arrow">‚ñ∂</span> {{ node.name }}
        </span>
        <ul class="collapsible" data-id="{{ node.id }}">
            {% for child in node.children %}
                {{ render_node(child) }}
            {% endfor %}
        </ul>
    {% else %}
        <li>
            {% if node.type == "agent" %}
                üë§ {{ node.name }}
            {% else %}
                {{ node.name }}
            {% endif %}
        </li>
    {% endif %}
</li>
{% endmacro %}

<ul id="tree-root">
{% for company in companies %}
    {{ render_node(company) }}
{% endfor %}
</ul>

<script>
const STORAGE_KEY = "tree-nodes";

function loadState() {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : {};
}

function saveState(state) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function toggle(el) {
    const next = el.nextElementSibling;
    if (!next) return;

    next.classList.toggle("expanded");

    const arrow = el.querySelector(".arrow");
    if (arrow) arrow.classList.toggle("expanded-arrow");

    const id = next.dataset.id;
    if (id) {
        const state = loadState();
        state[id] = next.classList.contains("expanded");
        saveState(state);
    }
}

window.addEventListener("DOMContentLoaded", () => {
    const state = loadState();
    const lists = document.querySelectorAll("#tree-root ul.collapsible");
    lists.forEach(ul => {
        const id = ul.dataset.id;
        if (id && state[id]) {
            ul.classList.add("expanded");
            const arrow = ul.previousElementSibling.querySelector(".arrow");
            if (arrow) arrow.classList.add("expanded-arrow");
        }
    });
});

let allExpanded = false;
function toggleAll() {
    const lists = document.querySelectorAll("#tree-root ul.collapsible");
    const state = loadState();
    lists.forEach(ul => {
        const arrow = ul.previousElementSibling.querySelector(".arrow");
        if (allExpanded) {
            ul.classList.remove("expanded");
            if (arrow) arrow.classList.remove("expanded-arrow");
            if (ul.dataset.id) state[ul.dataset.id] = false;
        } else {
            ul.classList.add("expanded");
            if (arrow) arrow.classList.add("expanded-arrow");
            if (ul.dataset.id) state[ul.dataset.id] = true;
        }
    });
    saveState(state);
    allExpanded = !allExpanded;
    document.getElementById("toggle-all-btn").textContent = allExpanded ? "–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë" : "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë";
}
</script>

</body>
</html>
