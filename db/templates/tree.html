<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Company Tree</title>
    <style>
      ul {
        list-style: none;
        padding-left: 20px;
        margin: 0;
      }

      .node {
        cursor: pointer;
        font-weight: bold;
        user-select: none;
        display: flex;
        align-items: center;
      }

      .arrow {
        display: inline-block;
        width: 1em;
        transition: transform 0.3s ease;
        margin-right: 5px;
      }

      .expanded-arrow {
        transform: rotate(90deg);
      }

      /* –ø–ª–∞–≤–Ω–æ–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ */
      .collapsible {
        overflow: hidden;
        max-height: 0;
        transition: max-height 0.3s ease;
      }

      .expanded {
        max-height: 2000px; /* –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
      }
    </style>
  </head>
  <body>
    <h2>Company ‚Üí Departments ‚Üí Agents</h2>

    <button id="toggle-all-btn" onclick="toggleAll()">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë</button>

    <ul id="tree-root">
      {% for company in companies %}
      <li>
        <span class="node" onclick="toggle(this)">
          <span class="arrow">‚ñ∂</span> üè¢ {{ company.name }}
        </span>
        <ul class="collapsible" data-id="company-{{ company.id }}">
          {% for dept in company.departments %}
          <li>
            <span class="node" onclick="toggle(this)">
              <span class="arrow">‚ñ∂</span> üè¨ {{ dept.name }}
            </span>
            <ul class="collapsible" data-id="dept-{{ dept.id }}">
              {% for agent in dept.agents %}
              <li>üë§ {{ agent.name }}</li>
              {% endfor %}
            </ul>
          </li>
          {% endfor %}
        </ul>
      </li>
      {% endfor %}
    </ul>

    <script>
      const STORAGE_KEY = "tree-nodes"; // –∫–ª—é—á localStorage

      // –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ localStorage
      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : {};
      }

      // —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–∑–ª–æ–≤
      function saveState(state) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —É–∑–ª–∞
      function toggle(el) {
        const next = el.nextElementSibling;
        if (!next) return;

        next.classList.toggle("expanded");

        // –≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É
        const arrow = el.querySelector(".arrow");
        if (arrow) arrow.classList.toggle("expanded-arrow");

        // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const id = next.dataset.id;
        if (id) {
          const state = loadState();
          state[id] = next.classList.contains("expanded");
          saveState(state);
        }
      }

      // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      window.addEventListener("DOMContentLoaded", () => {
        const state = loadState();
        const lists = document.querySelectorAll("#tree-root ul.collapsible");
        lists.forEach((ul) => {
          const id = ul.dataset.id;
          if (id && state[id]) {
            ul.classList.add("expanded");
            // –≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É
            const arrow = ul.previousElementSibling.querySelector(".arrow");
            if (arrow) arrow.classList.add("expanded-arrow");
          }
        });
      });

      // –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ
      let allExpanded = false;
      function toggleAll() {
        const lists = document.querySelectorAll("#tree-root ul.collapsible");
        const state = loadState();
        lists.forEach((ul) => {
          const arrow = ul.previousElementSibling.querySelector(".arrow");
          if (allExpanded) {
            ul.classList.remove("expanded");
            if (arrow) arrow.classList.remove("expanded-arrow");
            if (ul.dataset.id) state[ul.dataset.id] = false;
          } else {
            ul.classList.add("expanded");
            if (arrow) arrow.classList.add("expanded-arrow");
            if (ul.dataset.id) state[ul.dataset.id] = true;
          }
        });
        saveState(state);
        allExpanded = !allExpanded;
        document.getElementById("toggle-all-btn").textContent = allExpanded
          ? "–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë"
          : "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë";
      }
    </script>
  </body>
</html>
